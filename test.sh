#! /bin/bash

contract="${1:-$(cat /dev/stdin)}"

printf "\n\nstarting tests\n\n"

echo "fallback function"
seth send $contract
printf "^^^^^^^^^^ should fail ^^^^^^^^^^\n\n"

hash=$(seth keccak 0x00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000cb5000000000000000000000000000000000000000000000000000000000000bdf600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000061200e610000000000000000000000000000000000000000000000000000000061200e6f000000000000000000000000000000000000000000000000000000000000000265746875736400000000000000000000000000000000000000000000000000006274637573640000000000000000000000000000000000000000000000000000)

signature=$(ethsign msg --data $hash --passphrase-file ~/.dapp/password)

r="${signature:0:66}"
s="0x${signature:66:64}"
v="0x${signature:130}"

echo "poke"
seth send $contract 'poke(uint8,bytes32,bytes32,uint256[],uint256[],bytes32[])' $v $r $s [3253,48630] [1629490785,1629490799] [0x6574687573640000000000000000000000000000000000000000000000000000,0x6274637573640000000000000000000000000000000000000000000000000000]
printf "^^^^^ should revert with                              $ETH_FROM ^^^^^\n\n"

echo "lift"
seth send $contract 'lift(address)' $ETH_FROM
printf "^^^^ should succeed ^^^^^^\n\n"

echo "poke"
seth send $contract 'poke(uint8,bytes32,bytes32,uint256[],uint256[],bytes32[])' $v $r $s [3253,48630] [1629490785,1629490799] [0x6574687573640000000000000000000000000000000000000000000000000000,0x6274637573640000000000000000000000000000000000000000000000000000]
printf "^^^^^ should be         $ETH_FROM\n\n"

echo "poke again"
seth send $contract 'poke(uint8,bytes32,bytes32,uint256[],uint256[],bytes32[])' $v $r $s [3253,48630] [1629490785,1629490799] [0x6574687573640000000000000000000000000000000000000000000000000000,0x6274637573640000000000000000000000000000000000000000000000000000]
printf "^^^^^ should revert with                              $ETH_FROM ^^^^^\n\n"
